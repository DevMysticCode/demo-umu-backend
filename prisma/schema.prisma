generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(uuid())
  email                  String                 @unique
  password               String
  createdAt              DateTime               @default(now())
  dob                    DateTime?
  firstName              String?
  gender                 String?
  isVerified             Boolean                @default(false)
  lastName               String?
  phone                  String?
  postcode               String?
  passports              Passport[]
  passportCollaborations PassportCollaborator[]
}

model OtpCode {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model SectionTemplate {
  id                String             @id @default(uuid())
  key               String             @unique
  title             String
  subtitle          String?
  description       String?
  icon              String?
  order             Int
  createdAt         DateTime           @default(now())
  questionTemplates QuestionTemplate[]
}

model Passport {
  id            String                 @id @default(uuid())
  addressLine1  String                 @unique
  postcode      String
  ownerId       String
  status        PassportStatus         @default(IN_PROGRESS)
  createdAt     DateTime               @default(now())
  owner         User                   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  sections      PassportSection[]
  collaborators PassportCollaborator[]

  @@index([ownerId])
}

model PassportCollaborator {
  id         String   @id @default(uuid())
  passportId String
  userId     String
  createdAt  DateTime @default(now())
  passport   Passport @relation(fields: [passportId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([passportId, userId])
  @@index([passportId])
  @@index([userId])
}

model PassportSection {
  id          String                @id @default(uuid())
  passportId  String
  key         String
  title       String
  subtitle    String?
  description String?
  imageKey    String?
  order       Int
  status      SectionStatus         @default(LOCKED)
  createdAt   DateTime              @default(now())
  passport    Passport              @relation(fields: [passportId], references: [id], onDelete: Cascade)
  tasks       PassportSectionTask[]

  @@unique([passportId, key])
  @@index([passportId])
}

model PassportSectionTask {
  id                String             @id @default(uuid())
  passportSectionId String
  key               String
  title             String
  description       String?
  icon              String?
  order             Int
  status            TaskStatus         @default(PENDING)
  createdAt         DateTime           @default(now())
  passportQuestions PassportQuestion[]
  passportSection   PassportSection    @relation(fields: [passportSectionId], references: [id], onDelete: Cascade)

  @@unique([passportSectionId, key])
  @@index([passportSectionId])
}

model QuestionTemplate {
  id                  String             @id @default(uuid())
  sectionKey          String
  taskKey             String
  title               String
  description         String?
  instructionText     String?
  helpText            String?
  type                QuestionType
  options             Json?
  placeholder         String?
  displayMode         String?
  uploadInstruction   String?
  prewrittenTemplates Json?
  dateFields          Json?
  parts               Json?
  fields              Json?
  autoSaveOn          Json?
  repeatable          Boolean?
  buttonText          String?
  scaleType           String?
  scaleMin            Int?
  scaleMax            Int?
  scaleStep           Int?
  scaleFormat         String?
  scaleMaxLabel       String?
  externalLink        Json?
  otherPlaceholder    String?
  points              Int
  order               Int
  createdAt           DateTime           @default(now())
  passportQuestions   PassportQuestion[]
  sectionTemplate     SectionTemplate    @relation(fields: [sectionKey], references: [key])

  @@index([sectionKey, taskKey])
}

model PassportQuestion {
  id                    String              @id @default(uuid())
  passportSectionTaskId String
  questionTemplateId    String
  status                QuestionStatus      @default(PENDING)
  createdAt             DateTime            @default(now())
  passportSectionTask   PassportSectionTask @relation(fields: [passportSectionTaskId], references: [id], onDelete: Cascade)
  questionTemplate      QuestionTemplate    @relation(fields: [questionTemplateId], references: [id])
  answer                QuestionAnswer?

  @@index([passportSectionTaskId])
  @@index([questionTemplateId])
}

model QuestionAnswer {
  id                 String           @id @default(uuid())
  passportQuestionId String           @unique
  answerText         String?
  answerJson         Json?
  fileUrl            String?
  createdAt          DateTime         @default(now())
  passportQuestion   PassportQuestion @relation(fields: [passportQuestionId], references: [id], onDelete: Cascade)
}

enum PassportStatus {
  IN_PROGRESS
  COMPLETED
}

enum SectionStatus {
  LOCKED
  ACTIVE
  COMPLETED
}

enum TaskStatus {
  PENDING
  COMPLETED
}

enum QuestionStatus {
  PENDING
  COMPLETED
}

enum QuestionType {
  TEXT
  RADIO
  CHECKBOX
  UPLOAD
  MULTIPART
  NOTE
  DATE
  ADDRESS
  MULTITEXTINPUT
  MULTIFIELDFORM
  SCALE
  CHIPS
  BOUNDARY
}
